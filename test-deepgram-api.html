<!DOCTYPE html>
<html>
<head>
    <title>DeepGram Live Transcription Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; }
        .start-btn { background-color: #4CAF50; color: white; border: none; border-radius: 5px; }
        .stop-btn { background-color: #f44336; color: white; border: none; border-radius: 5px; }
        .stop-btn:disabled { background-color: #cccccc; cursor: not-allowed; }
        #status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .disconnected { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .connecting { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        #transcript { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; min-height: 200px; border-radius: 5px; }
        .transcript-entry { margin: 5px 0; padding: 5px; border-left: 3px solid #007bff; }
        .final { background-color: #e7f3ff; }
        .interim { background-color: #f0f0f0; font-style: italic; }
    </style>
</head>
<body>
    <h1>DeepGram Live Transcription Test</h1>
    <p><strong>Status:</strong> <span id="status" class="disconnected">Disconnected</span></p>
    
    <button id="startBtn" class="start-btn" onclick="startTranscription()">Start Recording & Transcription</button>
    <button id="stopBtn" class="stop-btn" onclick="stopTranscription()" disabled>Stop Recording & Transcription</button>
    <button onclick="clearTranscript()">Clear Transcript</button>
    <button onclick="releasePermissions()" style="background-color: #6c757d; color: white; border: none; border-radius: 5px; padding: 10px 20px; margin: 10px;">Release Microphone</button>
    
    <h3>Live Transcript:</h3>
    <div id="transcript">Click "Start Recording" to begin transcription...</div>
    
    <h3>Console Log:</h3>
    <div id="console" style="background-color: #000; color: #00ff00; padding: 10px; font-family: monospace; height: 150px; overflow-y: scroll;"></div>

    <script>
        const API_KEY = "1189b2a8085fcccbf10862e04038fc6ae660f610";
        let ws = null;
        let mediaRecorder = null;
        let stream = null;
        let transcriptCount = 0;
        let permissionsGranted = false;

        function log(message) {
            console.log(message);
            const consoleDiv = document.getElementById('console');
            consoleDiv.innerHTML += message + '<br>';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function updateStatus(status, className) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = status;
            statusEl.className = className;
        }

        async function startTranscription() {
            try {
                // Only request microphone access if we don't have it yet
                if (!permissionsGranted || !stream) {
                    log('🎤 Requesting microphone access...');
                    updateStatus('Requesting microphone access...', 'connecting');
                    
                    // Get microphone access
                    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    permissionsGranted = true;
                    log('✅ Microphone access granted');
                } else {
                    log('🎤 Using existing microphone access');
                }
                
                // Create WebSocket connection
                log('🔗 Connecting to DeepGram...');
                ws = new WebSocket('wss://api.deepgram.com/v1/listen?model=nova-3&language=en-US&smart_format=true&interim_results=true', ['token', API_KEY]);
                
                ws.onopen = () => {
                    log('✅ DeepGram WebSocket connected');
                    updateStatus('Connected - Recording...', 'connected');
                    
                    // Start recording
                    mediaRecorder = new MediaRecorder(stream);
                    
                    mediaRecorder.addEventListener('dataavailable', (event) => {
                        if (event.data.size > 0 && ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(event.data);
                            log(`📤 Sent audio chunk: ${event.data.size} bytes`);
                        }
                    });
                    
                    mediaRecorder.addEventListener('stop', () => {
                        log('🎙️ MediaRecorder stopped');
                    });
                    
                    mediaRecorder.addEventListener('error', (event) => {
                        log('❌ MediaRecorder error: ' + event.error);
                    });
                    
                    mediaRecorder.start(1000); // Send data every 1 second
                    
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'Results') {
                            const transcript = data.channel.alternatives[0].transcript;
                            if (transcript) {
                                transcriptCount++;
                                addTranscriptEntry(transcript, data.is_final, transcriptCount);
                                
                                if (data.is_final) {
                                    log(`✅ Final: "${transcript}"`);
                                } else {
                                    log(`⏳ Interim: "${transcript}"`);
                                }
                            }
                        } else if (data.type === 'Metadata') {
                            log('📊 Received metadata');
                        }
                    } catch (error) {
                        log('❌ Error parsing response: ' + error.message);
                    }
                };
                
                ws.onerror = (error) => {
                    log('❌ WebSocket error: ' + error);
                    updateStatus('Connection error', 'disconnected');
                };
                
                ws.onclose = (event) => {
                    log(`🔌 WebSocket closed: ${event.code} ${event.reason}`);
                    updateStatus('Disconnected', 'disconnected');
                    cleanup();
                };
                
            } catch (error) {
                log('❌ Error starting transcription: ' + error.message);
                updateStatus('Error: ' + error.message, 'disconnected');
            }
        }

        function stopTranscription() {
            log('🛑 Stopping transcription...');
            
            // Stop MediaRecorder first
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            // Wait a bit then close WebSocket
            setTimeout(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.close();
                }
            }, 100);
            
            // Clean up UI immediately
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            updateStatus('Stopping...', 'connecting');
        }

        function cleanup() {
            log('🧹 Cleaning up resources...');
            
            // Don't stop the media stream - keep it for reuse
            // Only clear the recorder and websocket references
            mediaRecorder = null;
            ws = null;
            
            // Update UI
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            updateStatus('Disconnected', 'disconnected');
        }

        function addTranscriptEntry(transcript, isFinal, count) {
            const transcriptDiv = document.getElementById('transcript');
            
            // Remove previous interim result for this turn
            const existingInterim = document.getElementById(`interim-${count}`);
            if (existingInterim) {
                existingInterim.remove();
            }
            
            const entry = document.createElement('div');
            entry.className = 'transcript-entry ' + (isFinal ? 'final' : 'interim');
            
            if (!isFinal) {
                entry.id = `interim-${count}`;
            }
            
            entry.innerHTML = `
                <strong>${isFinal ? 'Final' : 'Interim'} #${count}:</strong> ${transcript}
                <small style="float: right; color: #666;">${new Date().toLocaleTimeString()}</small>
            `;
            
            transcriptDiv.appendChild(entry);
            transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
        }

        function clearTranscript() {
            document.getElementById('transcript').innerHTML = 'Transcript cleared...';
            transcriptCount = 0;
        }

        function releasePermissions() {
            log('🔓 Releasing microphone permissions...');
            
            // Stop any active recording first
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            // Close WebSocket
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
            
            // Stop and release media stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                permissionsGranted = false;
                log('✅ Microphone permissions released');
            }
            
            // Clean up
            cleanup();
            updateStatus('Permissions released', 'disconnected');
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', releasePermissions);
    </script>
</body>
</html>